<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Environmental Monitor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Single Socket.IO include; avoid duplicates -->
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">

    <!-- Socket.IO Client Library -->
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>

    <!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""/>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""></script>


</head>
<body>
    <!-- Enhanced Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top" style="box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.1);">
        <div class="container-fluid">
            <a class="navbar-brand" href="#" style="padding: 0.75rem 1rem;">
                <i class="bi bi-cloud-drizzle me-2"></i>
                <span class="fw-bold">Environmental Monitor</span>
                <small class="badge bg-light text-dark ms-2">v2.0</small>
            </a>
            
            <div class="navbar-nav ms-auto">
                <!-- Real-time Status Indicator -->
                <div class="nav-item me-3 d-flex align-items-center">
                    <div class="status-indicator me-2">
                        <div class="status-dot" id="connectionDot"></div>
                    </div>
                    <span class="text-white" id="navConnectionStatus">Offline</span>
                </div>
                
                <!-- Theme Toggle -->
                <div class="theme-switch-wrapper me-3 d-flex align-items-center">
                    <label class="theme-switch" for="theme-toggle">
                        <input type="checkbox" id="theme-toggle">
                        <div class="slider"></div>
                    </label>
                    <span class="ms-2 text-white"><i class="bi bi-moon-stars"></i></span>
                </div>
                
                <!-- Settings Dropdown -->
                <div class="dropdown">
                    <button class="btn btn-outline-light btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="bi bi-gear"></i> Settings
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="/change_password"><i class="bi bi-key me-2"></i>Change Password</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="/logout"><i class="bi bi-box-arrow-right me-2"></i>Logout</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Dashboard Container -->
    <div class="container-fluid" style="margin-top: 80px;">
        
        <!-- Dashboard Header & Quick Stats -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card dashboard-header">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-lg-3 col-md-12 mb-3 mb-md-0">
                                <h2 class="mb-0 fw-bold text-primary">
                                    <i class="bi bi-speedometer2 me-2"></i>Dashboard
                                </h2>
                                <p class="text-muted mb-0">Real-time Environmental Monitoring</p>
                            </div>
                            <div class="col-lg-9 col-md-12">
                                <div class="row g-3">
                                    <div class="col-6 col-md-4 col-lg-2">
                                        <div class="quick-stat card p-2 p-md-3 h-100 shadow-sm border-0">
                                            <div class="d-flex align-items-center">
                                                <div class="stat-icon bg-primary rounded-circle d-flex align-items-center justify-content-center">
                                                    <i class="bi bi-cpu fs-4"></i>
                                                </div>
                                                <div class="stat-info ms-3">
                                                    <h5 id="totalDevices" class="mb-0 fw-bold">{{ devices|length }}</h5>
                                                    <small class="text-muted">Devices</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="quick-stat card p-3 h-100 shadow-sm border-0">
                                            <div class="d-flex align-items-center">
                                                <div class="stat-icon bg-success rounded-circle d-flex align-items-center justify-content-center">
                                                    <i class="bi bi-wifi fs-4"></i>
                                                </div>
                                                <div class="stat-info ms-3">
                                                    <h5 id="onlineDevices" class="mb-0 fw-bold">0</h5>
                                                    <small class="text-muted">Online</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="quick-stat card p-3 h-100 shadow-sm border-0">
                                            <div class="d-flex align-items-center">
                                                <div class="stat-icon bg-warning rounded-circle d-flex align-items-center justify-content-center">
                                                    <i class="bi bi-exclamation-triangle fs-4"></i>
                                                </div>
                                                <div class="stat-info ms-3">
                                                    <h5 id="alertCount" class="mb-0 fw-bold">0</h5>
                                                    <small class="text-muted">Alerts</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="quick-stat card p-3 h-100 shadow-sm border-0">
                                            <div class="d-flex align-items-center">
                                                <div class="stat-icon bg-info rounded-circle d-flex align-items-center justify-content-center">
                                                    <i class="bi bi-graph-up fs-4"></i>
                                                </div>
                                                <div class="stat-info ms-3">
                                                    <h5 id="avgPM25" class="mb-0 fw-bold">--</h5>
                                                    <small class="text-muted">Avg PM2.5</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="quick-stat card p-3 h-100 shadow-sm border-0">
                                            <div class="d-flex align-items-center">
                                                <div class="stat-icon bg-danger rounded-circle d-flex align-items-center justify-content-center">
                                                    <i class="bi bi-thermometer-high fs-4"></i>
                                                </div>
                                                <div class="stat-info ms-3">
                                                    <h5 id="maxTemp" class="mb-0 fw-bold">--°C</h5>
                                                    <small class="text-muted">Max Temp</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="quick-stat card p-3 h-100 shadow-sm border-0">
                                            <div class="d-flex align-items-center">
                                                <div class="stat-icon bg-secondary rounded-circle d-flex align-items-center justify-content-center">
                                                    <i class="bi bi-clock fs-4"></i>
                                                </div>
                                                <div class="stat-info ms-3">
                                                    <h5 id="lastUpdateTime" class="mb-0 fw-bold">--</h5>
                                                    <small class="text-muted">Last Update</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modern Device Selection & Quick Actions -->
        <div class="row mb-3">
            <div class="col-lg-8">
                <div class="card enhanced-card floating-card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-microchip me-2 text-primary"></i>Device Selection
                            <span id="deviceTypeIndicator" class="badge bg-secondary ms-2" style="display: none;">BASIC</span>
                        </h5>
                        <button class="btn btn-modern btn-sm" id="toggleMapView">
                            <i class="fas fa-map" id="mapToggleIcon"></i>
                            <span id="mapToggleText">Show Map</span>
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-9">
                                <label for="deviceSelect" class="form-label fw-bold">Select Device:</label>
                        <select class="form-select form-select-lg" id="deviceSelect">
                            <option value="">Select a device...</option>
                            {% for device in devices %}
                            <option value="{{ device.id }}"
                                    data-name="{{ device.name }}"
                                    data-deviceid="{{ device.deviceid }}"
                                    data-type="{{ 'extended' if device.source_type == 'mqtt' else 'basic' }}"
                                    data-relay="{{ device.has_relay }}">
                                {{ device.name }} ({{ device.deviceid }})
                                {% if device.source_type == 'mqtt' %}[Extended]{% endif %}
                                {% if device.has_relay %}[Relay]{% endif %}
                            </option>
                            {% endfor %}
                        </select>

                        <!-- Debug Information -->
                        {% if debug_info %}
                        <div class="alert alert-info mt-2">
                            <small>
                                <strong>Debug Info:</strong><br>
                                Device Count: {{ debug_info.device_count }}<br>
                                Devices: {{ debug_info.device_list|join(', ') }}
                            </small>
                        </div>
                        {% endif %}
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-bold">Actions:</label>
                                <div class="d-grid gap-2">
                                    <button type="button" class="btn btn-outline-info btn-sm" id="refreshDeviceList">
                                        <i class="fas fa-sync-alt me-1"></i>Refresh
                                    </button>
                                    <button type="button" class="btn btn-outline-success btn-sm" id="autoSelectDevice">
                                        <i class="fas fa-magic me-1"></i>Auto
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Map Selection (Initially Hidden) -->
                        <div id="mapSelectionContainer" style="display: none;" class="mt-3">
                            <div class="border rounded p-3 bg-light">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <label class="form-label mb-0 fw-bold">
                                        <i class="fas fa-map-marker-alt me-1 text-primary"></i>Select Device from Map:
                                    </label>
                                    <div class="btn-group btn-group-sm">
                                        <button type="button" class="btn btn-outline-secondary" id="refreshDeviceMapBtn">
                                            <i class="fas fa-sync-alt"></i>
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary" id="fitDeviceMapBtn">
                                            <i class="fas fa-expand-arrows-alt"></i>
                                        </button>
                                    </div>
                                </div>
                                <div id="deviceSelectMap" style="height: 350px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions Sidebar -->
            <div class="col-lg-4">
                <div class="row g-3">
                    <!-- Data Export -->
                    <div class="col-12">
                        <div class="card enhanced-card">
                            <div class="card-header">
                                <i class="bi bi-download me-2 text-success"></i>Data Export
                                <div class="float-end">
                                    <small class="text-muted" id="exportCount">0 records</small>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="date-range-selector mb-3">
                                    <div class="row g-2">
                                        <div class="col-6">
                                            <label class="form-label small">From:</label>
                                            <input type="date" id="start-date" class="form-control form-control-sm">
                                        </div>
                                        <div class="col-6">
                                            <label class="form-label small">To:</label>
                                            <input type="date" id="end-date" class="form-control form-control-sm">
                                        </div>
                                    </div>
                                </div>
                                <button class="btn btn-modern csv-export-btn w-100" onclick="exportData()">
                                    <i class="bi bi-file-earmark-spreadsheet me-2"></i>Export CSV
                                </button>
                            </div>
                        </div>
                    </div>


                </div>
            </div>
        </div>





        <!-- Enhanced Tabs -->
        <ul class="nav nav-tabs dashboard-tabs" id="deviceTypeTabs" role="tablist" style="display: none;">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button">
                    <i class="bi bi-speedometer2 me-2"></i>Overview
                    <span class="badge bg-primary ms-2" id="overviewBadge">Live</span>
                </button>
            </li>
            <li class="nav-item" role="presentation" id="environmental-tab-li" style="display: none;">
                <button class="nav-link" id="environmental-tab" data-bs-toggle="tab" data-bs-target="#environmental" type="button">
                    <i class="bi bi-thermometer-half me-2"></i>Environmental
                    <span class="badge bg-success ms-2" id="envBadge">+6</span>
                </button>
            </li>

            <li class="nav-item" role="presentation" id="settings-tab-li" style="display: none;">
                <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button">
                    <i class="bi bi-sliders me-2"></i>Settings
                    <span class="badge bg-secondary ms-2" id="settingsBadge">⚙️</span>
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content dashboard-content" id="deviceTypeTabContent">
            
            <!-- Overview Tab -->
            <div class="tab-pane fade show active" id="overview" role="tabpanel">
                <div class="row mt-3">
                    
                    <!-- Main Chart Section -->
                    <div class="col-xl-8 col-lg-7 mb-4">
                        <div class="card enhanced-card chart-card shadow-sm border-0">
                            <div class="card-header bg-light">
                                <div class="d-flex flex-wrap justify-content-between align-items-center">
                                    <div class="mb-2 mb-md-0">
                                        <h5 class="mb-0">
                                            <i class="bi bi-graph-up me-2"></i>PM Levels Over Time
                                        </h5>
                                        <small class="text-muted">Real-time particulate matter monitoring</small>
                                    </div>
                                    <div class="chart-controls">
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button class="btn btn-outline-primary" onclick="toggleChartType('line')">
                                                <i class="bi bi-graph-up"></i>
                                            </button>
                                            <button class="btn btn-outline-primary" onclick="toggleChartType('bar')">
                                                <i class="bi bi-bar-chart"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="chart-container" style="overflow: hidden; position: relative; height: 500px;">
                                    <canvas id="timeChart"></canvas>
                                </div>
                                <!-- Chart Legend with Statistics -->
                                <div class="chart-legend mt-3">
                                    <div class="row row-cols-2 row-cols-md-3 row-cols-lg-5 text-center g-2">
                                        <div class="col">
                                            <div class="legend-item p-1">
                                                <div class="legend-color" style="background: rgba(255, 99, 132, 0.8);"></div>
                                                <span>PM1: <strong id="pm1-stat">-- μg/m³</strong></span>
                                            </div>
                                        </div>
                                        <div class="col">
                                            <div class="legend-item p-1">
                                                <div class="legend-color" style="background: rgba(54, 162, 235, 0.8);"></div>
                                                <span>PM2.5: <strong id="pm25-stat">-- μg/m³</strong></span>
                                            </div>
                                        </div>
                                        <div class="col">
                                            <div class="legend-item p-1">
                                                <div class="legend-color" style="background: rgba(75, 192, 192, 0.8);"></div>
                                                <span>PM4: <strong id="pm4-stat">-- μg/m³</strong></span>
                                            </div>
                                        </div>
                                        <div class="col">
                                            <div class="legend-item p-1">
                                                <div class="legend-color" style="background: rgba(255, 206, 86, 0.8);"></div>
                                                <span>PM10: <strong id="pm10-stat">-- μg/m³</strong></span>
                                            </div>
                                        </div>
                                        <div class="col">
                                            <div class="legend-item p-1">
                                                <div class="legend-color" style="background: rgba(153, 102, 255, 0.8);"></div>
                                                <span>TSP: <strong id="tsp-stat">-- μg/m³</strong></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sidebar Cards -->
                    <div class="col-xl-4 col-lg-5 mt-4 mt-lg-0">
                        
                        <!-- Current Readings -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="bi bi-eye me-2"></i>Current PM Levels
                                    <div class="float-end">
                                        <small class="text-muted" id="readingsTime">--:--</small>
                                    </div>
                                </h6>
                            </div>
                            <div class="card-body" style="overflow-y: auto; max-height: 200px;">
                                <div id="pmReadings" class="pm-readings-grid">
                                    <!-- PM readings will be populated by JS -->
                                </div>
                            </div>
                        </div>

                        <!-- Extended Data Preview (for extended devices) -->
                        <div class="card mb-4" id="extendedPreview" style="display: none;">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="bi bi-cloud-sun me-2"></i>Environmental Summary
                                </h6>
                            </div>
                            <div class="card-body">
                                <div id="environmentalSummary" class="environmental-summary">
                                    <div class="row text-center">
                                        <div class="col-6 mb-2">
                                            <div class="environmental-summary-item">
                                                <i class="bi bi-thermometer-half text-danger"></i>
                                                <small class="text-muted d-block">Temperature</small>
                                                <strong class="h6">--</strong>
                                            </div>
                                        </div>
                                        <div class="col-6 mb-2">
                                            <div class="environmental-summary-item">
                                                <i class="bi bi-droplet-half text-info"></i>
                                                <small class="text-muted d-block">Humidity</small>
                                                <strong class="h6">--</strong>
                                            </div>
                                        </div>
                                        <div class="col-6 mb-2">
                                            <div class="environmental-summary-item">
                                                <i class="bi bi-cloud-haze2 text-warning"></i>
                                                <small class="text-muted d-block">VOC</small>
                                                <strong class="h6">--</strong>
                                            </div>
                                        </div>

                                        <div class="col-6 mb-2">
                                            <div class="environmental-summary-item">
                                                <i class="bi bi-volume-up text-purple"></i>
                                                <small class="text-muted d-block">Noise</small>
                                                <strong class="h6">--</strong>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Air Quality Index Card -->
                        <div class="card mb-4" id="aqiCard">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="bi bi-lungs me-2"></i>Air Quality Index
                                </h6>
                            </div>
                            <div class="card-body text-center">
                                <div class="aqi-circle" id="aqiCircle">
                                    <div class="aqi-value" id="aqiValue">--</div>
                                    <div class="aqi-label" id="aqiLabel">Calculating...</div>
                                </div>
                                <div class="aqi-description mt-3">
                                    <small id="aqiDescription" class="text-muted">Select a device to see AQI</small>
                                </div>
                            </div>
                        </div>

                        <!-- Threshold Alerts -->
                        <div class="card threshold-alerts" id="thresholdAlerts" style="display: none;">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="bi bi-exclamation-triangle-fill me-2"></i>Threshold Alerts
                                    <span class="badge bg-danger ms-2" id="alertsBadge">0</span>
                                </h6>
                            </div>
                            <div class="card-body">
                                <div id="alertsContainer">
                                    <!-- Alerts will be populated by JS -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Environmental Tab -->
            <div class="tab-pane fade" id="environmental" role="tabpanel">
                <div class="row mt-3">
                    
                    <!-- Environmental Charts Grid -->
                    <div class="col-lg-6 mb-4">
                        <div class="card chart-card">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="bi bi-thermometer-half me-2"></i>Temperature & Humidity
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="tempHumidityChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-6 mb-4">
                        <div class="card chart-card">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="bi bi-speedometer me-2"></i>Pressure & Air Quality
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="pressureAirQualityChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-6 mb-4">
                        <div class="card chart-card">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="bi bi-cloud-haze2 me-2"></i>NO₂ Levels
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="no2Chart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-6 mb-4">
                        <div class="card chart-card">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="bi bi-volume-up me-2"></i>Noise Levels
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="noiseChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Live Environmental Data Cards -->
                <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4 mb-4" id="environmentalDataContainer">
                    <!-- Cards will be dynamically loaded here -->
                </div>
            </div>



            <!-- Settings Tab -->
            <div class="tab-pane fade" id="settings" role="tabpanel">
                <div class="row mt-3">
                    <div class="col-lg-6 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="bi bi-sliders me-2"></i>Threshold Configuration
                                </h6>
                            </div>
                            <div class="card-body">
                                <div id="thresholdSettings">
                                    <!-- Threshold settings will be populated by JS -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-6 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="bi bi-toggles2 me-2"></i>Relay Control
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Relay Operation Mode:</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="relayMode" id="manualMode" value="manual" checked>
                                        <label class="form-check-label" for="manualMode">
                                            <i class="bi bi-hand-index me-2"></i>Manual Control
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="relayMode" id="autoMode" value="auto">
                                        <label class="form-check-label" for="autoMode">
                                            <i class="bi bi-gear me-2"></i>Auto (Threshold Based)
                                        </label>
                                    </div>
                                </div>
                                
                                <div id="manualControls">
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-success" onclick="controlRelay('ON')">
                                            <i class="bi bi-power me-2"></i>Turn ON
                                        </button>
                                        <button class="btn btn-danger" onclick="controlRelay('OFF')">
                                            <i class="bi bi-power me-2"></i>Turn OFF
                                        </button>
                                    </div>
                                </div>

                                <div id="autoControls" style="display: none;">
                                    <div class="mb-3">
                                        <label for="autoThreshold" class="form-label">Auto ON Threshold (PM2.5)</label>
                                        <input type="number" class="form-control" id="autoThreshold" value="75">
                                    </div>
                                    <button class="btn btn-primary w-100" onclick="updateAutoMode()">
                                        <i class="bi bi-check2 me-2"></i>Update Auto Mode
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Modal -->
    <div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-sm modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center">
                    <div class="loading-spinner">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <div class="loading-dots mt-2">
                            <span class="dot"></span>
                            <span class="dot"></span>
                            <span class="dot"></span>
                        </div>
                    </div>
                    <div class="mt-3">
                        <h6 class="mb-1">Loading data...</h6>
                        <small class="text-muted" id="loadingProgress">Please wait</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Success/Error Toast Container -->
    <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 11;">
        <!-- Toasts will be dynamically added here -->
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='script.js') }}"></script>

    <!-- Additional styles for enhanced UI -->
    <style>
        /* Enhanced Status Indicators */
        .status-indicator {
            position: relative;
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #dc3545;
            animation: pulse 2s infinite;
        }
        
        .status-dot.online {
            background: #28a745;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); }
            100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
        }

        /* Enhanced Dashboard Cards */
        .dashboard-header {
            background: linear-gradient(135deg, var(--card-bg) 0%, rgba(13, 110, 253, 0.05) 100%);
            border-left: 4px solid #0d6efd;
        }

        .quick-stat {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .quick-stat:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .stat-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 0.75rem;
            color: white;
        }

        .stat-info h5 {
            font-weight: 700;
            margin-bottom: 0;
        }

        /* Enhanced Chart Cards */
        .chart-card {
            border-left: 4px solid #17a2b8;
            transition: all 0.3s ease;
        }

        .chart-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        /* Enhanced Environmental Cards */
        .environmental-card {
            border-radius: 15px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .environmental-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4, #ffeaa7);
        }

        .environmental-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }

        .env-icon {
            font-size: 2rem;
            margin-bottom: 1rem;
            opacity: 0.8;
        }

        .env-trend {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 1.2rem;
        }

        /* Enhanced AQI Circle */
        .aqi-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 4px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .aqi-value {
            font-size: 2rem;
            font-weight: bold;
        }

        .aqi-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            font-weight: 600;
        }

        /* Enhanced PM Readings Grid */
        .pm-readings-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0.75rem;
        }

        .pm-reading-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: rgba(13, 110, 253, 0.05);
            border-radius: 8px;
            border-left: 4px solid #0d6efd;
        }

        /* Enhanced GPS Info Grid */
        .gps-info-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0.75rem;
        }

        .gps-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .gps-item:last-child {
            border-bottom: none;
        }

        .gps-label {
            font-weight: 600;
            color: var(--text-color);
        }

        .gps-value {
            font-family: 'Courier New', monospace;
            color: #0d6efd;
            font-weight: 500;
        }

        /* Enhanced Map Container */
        .map-container {
            height: 400px;
            border-radius: 8px;
            overflow: hidden;
        }

        /* Enhanced Chart Legend */
        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            border-radius: 6px;
            background: rgba(0,0,0,0.02);
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.5);
        }

        /* Enhanced Loading Animation */
        .loading-dots {
            display: flex;
            justify-content: center;
            gap: 0.25rem;
        }

        .dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #0d6efd;
            animation: loadingDots 1.4s infinite ease-in-out both;
        }

        .dot:nth-child(1) { animation-delay: -0.32s; }
        .dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes loadingDots {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        /* Enhanced Tab Badges */
        .nav-tabs .nav-link .badge {
            font-size: 0.65rem;
            padding: 0.25em 0.4em;
        }

        /* Device Info Panel */
        .device-info-panel {
            margin-top: 1rem;
        }

        .device-status-card {
            background: rgba(13, 110, 253, 0.05);
            border-radius: 8px;
            padding: 1rem;
            border: 1px solid rgba(13, 110, 253, 0.1);
        }

        /* Responsive Enhancements */
        @media (max-width: 768px) {
            .quick-stat {
                flex-direction: column;
                text-align: center;
                margin-bottom: 1rem;
            }
            
            .stat-icon {
                margin-right: 0;
                margin-bottom: 0.5rem;
            }
            
            .environmental-card .display-4 {
                font-size: 1.5rem;
            }
        }
    </style>

</body>
</html>
